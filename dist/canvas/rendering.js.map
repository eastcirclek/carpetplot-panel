{"version":3,"sources":["../../src/canvas/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","canvas","context","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","invertedYScale","xScale","colorScale","fragment","mouseUpHandler","originalPointColor","pointWidth","pointHeight","highlightedBucket","$canvas","targets","selection","active","x1","x2","y","events","on","render","renderingCompleted","addCarpetplot","addCarpetplotSvg","length","getMinMax","getColorScale","addAxes","addCanvas","addPoints","appEvents","drawSharedCrosshair","event","pos","clearCrosshair","Math","floor","remove","d3","select","append","attr","xAxis","hideLabels","addYAxis","yAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","show","selectAll","style","ticks","scaleOrdinal","domain","range","scaleQuantize","axisLeft","tickValues","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","$","outerWidth","moment","utc","timestamp","startOf","add","scaleUtc","axisBottom","tickSize","grafanaTimeFormat","secPerTick","oneDay","oneYear","insert","node","getContext","lineWidth","customBase","document","createElement","container","pointScale","scaleLinear","cols","enter","points","d","i","_","map","buckets","value","target","color","nullColor","drawPoints","clearRect","elements","each","fillStyle","fillRect","strokeStyle","STROKE_STYLE","strokeRect","scale","isSet","stats","colorScheme","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","getMousePos","isInChart","x","onMouseUp","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","from","to","template","update","variable","variableSrv","variables","variableToUpdate","current","updateOptions","then","variableUpdated","$scope","$emit","$root","$broadcast","clearSelection","onMouseLeave","emit","onMouseMove","drawSelection","emitGraphHoverEvent","drawCrosshair","bucket","getBucket","highlightPoint","resetPointHighLight","destroy","offsetX","valueOf","pageX","pageY","panelRelY","offsetY","hasValue","equals","highlightColor","darker","getBoundingClientRect","window","scrollX","scrollY","crosshair","showCrosshair","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legend","legendWidth","legendHeight","drawLegend","rangeStep","legendColorScale","valuesRange","bucketTimestamp","getBucketTimestamp","xTime","index","getBucketIndex","bucketIndex","indexOf","bucketX","toDate","bucketY","has","hasData","noDataPoints","html","getFragment","empty","tickStep"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\nimport _ from 'lodash';\nimport { appEvents, contextSrv } from 'app/core/core';\nimport { tickStep } from 'app/core/utils/ticks';\nimport moment from 'moment';\nimport $ from 'jquery';\n\nimport { getFragment } from '../fragments';\nimport CarpetplotTooltip from './tooltip';\n\nconst\n  Y_AXIS_TICK_PADDING = 5,\n  MIN_SELECTION_WIDTH = 2,\n  STROKE_STYLE = 'white';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  let data, panel, timeRange, carpet, canvas, context;\n\n  const $carpet = elem.find('.carpetplot-panel');\n  const tooltip = new CarpetplotTooltip($carpet, scope, ctrl);\n\n  const margin = { left: 25, right: 15, top: 10, bottom: 10 };\n\n  let width, height,\n    min, max,\n    xFrom, xTo,\n    chartHeight, chartWidth,\n    chartTop, chartBottom,\n    xAxisHeight, yAxisWidth,\n    yScale, invertedYScale, xScale,\n    colorScale, fragment,\n    mouseUpHandler,\n    originalPointColor,\n    pointWidth, pointHeight,\n    highlightedBucket,\n    $canvas;\n\n  let targets;\n\n  const selection = {\n    active: false,\n    x1: -1,\n    x2: -1,\n    y: -1\n  };\n\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function addCarpetplot() {\n    if (!data.data || !data.data[0]) { return; }\n\n    addCarpetplotSvg();\n    if (data.targets.length > 0) {\n      [min, max] = getMinMax();\n      colorScale = getColorScale(min, max);\n\n      addAxes();\n      addCanvas();\n      addPoints();\n\n      appEvents.on('graph-hover', event => {\n        drawSharedCrosshair(event.pos);\n      }, scope);\n\n      appEvents.on('graph-hover-clear', () => {\n        clearCrosshair()\n      }, scope);\n    } else {\n      // todo : nothing to show here\n    }\n  }\n\n  function addCarpetplotSvg() {\n    width = Math.floor($carpet.width());\n    height = ctrl.height;\n\n    if (carpet) {\n      carpet.remove();\n    }\n\n    if (canvas) {\n      canvas.remove();\n    }\n\n    carpet = d3.select($carpet[0])\n      .append('svg')\n      .attr('width', width)\n      .attr('height', height);\n  }\n\n  function addAxes() {\n    xAxisHeight = panel.xAxis.hideLabels ? 0 : 10;\n    chartHeight = height - margin.top - margin.bottom - xAxisHeight;\n    pointHeight = Math.max(0, chartHeight / targets.length);\n    chartTop = margin.top;\n    chartBottom = chartTop + chartHeight;\n\n    addYAxis();\n    yAxisWidth = panel.yAxis.hideLabels ? 0 : (getYAxisWidth() + Y_AXIS_TICK_PADDING);\n    chartWidth = width - yAxisWidth - margin.right;\n\n    addXAxis();\n\n    pointWidth = Math.max(0, chartWidth / data.data.length);\n\n    if (!panel.yAxis.show) {\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\n    }\n\n    if (!panel.xAxis.show) {\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\n    }\n  }\n\n  function addYAxis() {\n    const ticks = data.targets;\n\n    yScale = d3.scaleOrdinal()\n      .domain(ticks)\n      .range(d3.range(0, chartHeight, chartHeight / ticks.length));\n\n    invertedYScale = d3.scaleQuantize()\n      .domain([0, chartHeight])\n      .range(yScale.domain());\n\n    const yAxis = d3.axisLeft(yScale)\n      .tickValues(ticks)\n      .tickSizeInner(0 - width)\n      .tickSizeOuter(0)\n      .tickPadding(Y_AXIS_TICK_PADDING);\n\n    if (!panel.yAxis.hideLabels) {\n      carpet.append('g')\n        .attr('class', 'axis axis-y')\n        .call(yAxis);\n\n      const posY = margin.top + pointHeight/2;\n      const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\n\n      const yAxisGroup = carpet.select('.axis-y');\n      yAxisGroup.attr('transform', `translate(${posX},${posY})`);\n      yAxisGroup.select('.domain').remove();\n      yAxisGroup.selectAll('.tick line').remove();\n    }\n  }\n\n  function getYAxisWidth() {\n    const axisText = carpet.selectAll('.axis-y text').nodes();\n    return d3.max(axisText, (text) => $(text).outerWidth());\n  }\n\n  function addXAxis() {\n    xFrom = moment.utc(data.data[0].timestamp).startOf('day');\n    xTo = moment.utc(data.data[data.data.length - 1].timestamp).startOf('day').add(1, 'day');\n\n    xScale = d3.scaleUtc()\n      .domain([xFrom, xTo])\n      .range([0, chartWidth]);\n\n    const xAxis = d3.axisBottom(xScale)\n      .ticks()\n      .tickSize(chartHeight);\n\n    const posY = margin.top;\n    const posX = yAxisWidth;\n\n    if (!panel.xAxis.hideLabels) {\n      carpet.append('g')\n        .attr('class', 'axis axis-x')\n        .attr('transform', `translate(${posX},${posY})`)\n        .call(xAxis)\n      carpet.select('.axis-x').selectAll('.tick line, .domain').remove();\n    }\n  }\n\n  function grafanaTimeFormat(ticks, min, max) {\n    if (min && max && ticks) {\n      let range = max - min;\n      let secPerTick = (range/ticks) / 1000;\n      let oneDay = 86400000;\n      let oneYear = 31536000000;\n\n      if (secPerTick <= 45) {\n        return \"%H:%M:%S\";\n      }\n      if (secPerTick <= 7200 || range <= oneDay) {\n        return \"%H:%M\";\n      }\n      if (secPerTick <= 80000) {\n        return \"%m/%d %H:%M\";\n      }\n      if (secPerTick <= 2419200 || range <= oneYear) {\n        return \"%m/%d\";\n      }\n      return \"%Y-%m\";\n    }\n\n    return \"%H:%M\";\n  }\n\n  function addCanvas() {\n    if (canvas) {\n      canvas.remove();\n    }\n\n    canvas = d3.select($carpet[0])\n      .insert('canvas', ':first-child')\n      .attr('width', chartWidth)\n      .attr('height', chartHeight)\n      .style('left', `${yAxisWidth}px`)\n      .style('top', `${margin.top}px`);\n\n    $canvas = $(canvas.node());\n\n    context = canvas.node().getContext('2d');\n    context.lineWidth = 0.5;\n  }\n\n  function addPoints() {\n    const customBase = document.createElement('custom');\n\n    const container = d3.select(customBase);\n\n    const pointScale = d3.scaleLinear()\n      .domain([0, targets.length])\n      .range([0, chartHeight]);\n\n    const cols = container\n      .selectAll('custom.carpet-col')\n      .data(data.data)\n      .enter()\n      .append('custom')\n      .attr('class', 'carpet-col');\n\n    const points = cols\n      .selectAll('custom.carpet-point')\n      .data((d, i) =>\n        _.map(d.buckets, function(value, target) {\n          return {\n            value,\n            target: target,\n            timestamp: d.timestamp\n          }\n        })\n      )\n      .enter()\n      .append('custom')\n      .attr('class', 'carpet-point')\n      .attr('fillStyle', ({ value }) => value === null ? panel.color.nullColor : colorScale(value))\n      .attr('x', (d) => xScale(moment.utc(d.timestamp)))\n      .attr('y', (d, i) => pointScale(i));\n\n    drawPoints(cols);\n  }\n\n  function drawPoints(cols) {\n    context.clearRect(0, 0, chartWidth, chartHeight);\n\n    const elements = cols.selectAll('custom.carpet-point')\n      .each(function (d, i) {\n        const node = d3.select(this);\n\n        context.fillStyle = node.attr('fillStyle');\n        context.fillRect(node.attr('x'), node.attr('y'), pointWidth, pointHeight);\n\n        context.strokeStyle = STROKE_STYLE;\n        context.strokeRect(node.attr('x'), node.attr('y'), pointWidth, pointHeight);\n      });\n  }\n\n  function getMinMax() {\n    const { min, max } = panel.scale;\n    return [\n      isSet(min) ? min : data.stats.min,\n      isSet(max) ? max : data.stats.max\n    ];\n  }\n\n  function getColorScale(min, max) {\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\n    const colorInterpolator = d3[colorScheme.value];\n    let colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\n    colorScaleInverted = panel.color.invert ? !colorScaleInverted : colorScaleInverted;\n\n    const start = colorScaleInverted ? max : min;\n    const end = colorScaleInverted ? min : max;\n\n    return d3\n      .scaleSequential(colorInterpolator)\n      .domain([start, end]);\n  }\n\n  function isSet(prop) {\n    return prop !== undefined && prop !== null && prop !== '';\n  }\n\n  function onMouseDown(event) {\n    const pos = getMousePos(event);\n    if (!isInChart(pos)) { return; }\n\n    selection.active = true;\n    selection.x1 = pos.x;\n    selection.y = pos.y;\n\n    mouseUpHandler = () => onMouseUp();\n\n    $(document).one('mouseup', mouseUpHandler);\n  }\n\n  function onMouseUp() {\n    $(document).unbind('mouseup', mouseUpHandler);\n    mouseUpHandler = null;\n    selection.active = false;\n\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\n\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\n      const timeFrom = moment.utc(xScale.invert(Math.min(selection.x1, selection.x2)));\n      const timeTo = moment.utc(xScale.invert(Math.max(selection.x1, selection.x2)));\n\n      ctrl.timeSrv.setTime({\n        from: moment.utc(timeFrom),\n        to: moment.utc(timeTo)\n      });\n    } else {\n\n      if (ctrl.panel.template.update) {\n        const target = invertedYScale(selection.y);\n\n        const variable = _.find(ctrl.variableSrv.variables, {\"name\": ctrl.panel.template.variableToUpdate});\n        variable.current.text = target;\n        variable.current.value = [target];\n\n        ctrl.variableSrv.updateOptions(variable).then(() => {\n          ctrl.variableSrv.variableUpdated(variable).then(() => {\n            ctrl.$scope.$emit('template-variable-value-updated');\n            ctrl.$scope.$root.$broadcast('refresh');\n          });\n        });\n      }\n    }\n\n    clearSelection();\n  }\n\n  function onMouseLeave() {\n    appEvents.emit('graph-hover-clear');\n    clearCrosshair();\n  }\n\n  function onMouseMove(event) {\n    if (!carpet) { return; }\n    if (!$canvas) { return; }\n\n    const pos = getMousePos(event);\n\n    if (selection.active) {\n      selection.x2 = pos.x;\n      drawSelection(selection.x1, selection.x2);\n    }\n    emitGraphHoverEvent(event, pos);\n\n    drawCrosshair(pos);\n\n    const bucket = getBucket(pos);\n    if (bucket) {\n      tooltip.show(pos, bucket);\n      highlightPoint(pos, bucket);\n    } else {\n      resetPointHighLight();\n      tooltip.destroy();\n    }\n  }\n\n  function emitGraphHoverEvent(event, pos) {\n    const x = xScale.invert(event.offsetX - yAxisWidth).valueOf();\n    const target = invertedYScale(pos.y);\n\n    // broadcast to other graph panels that we are hovering\n    appEvents.emit('graph-hover',\n      {\n        pos:\n          {\n            pageX: event.pageX,\n            pageY: event.pageY,\n            x: x, x1: x,\n            // Set minimum offset to prevent showing legend from another panel\n            panelRelY: Math.max(event.offsetY / height, 0.001)\n          },\n        panel: panel,\n        target: target\n      }\n    );\n  }\n\n  function highlightPoint(pos, bucket) {\n    if (!isInChart(pos) || !bucket || !bucket.hasValue()) {\n      resetPointHighLight();\n      return;\n    }\n\n    if (bucket.equals(highlightedBucket)) {\n      return;\n    } else {\n      resetPointHighLight();\n    }\n\n    highlightedBucket = bucket;\n\n    const { value, x, y } = bucket;\n\n    const color = colorScale(value);\n    const highlightColor = d3.color(color).darker(1);\n    originalPointColor = color;\n\n    context.fillStyle = highlightColor;\n    context.fillRect(x, y, pointWidth, pointHeight);\n\n    context.strokeStyle = STROKE_STYLE;\n    context.strokeRect(x, y, pointWidth, pointHeight);\n  }\n\n  function resetPointHighLight() {\n    if (!highlightedBucket) { return; }\n\n    const { x, y } = highlightedBucket;\n    context.fillStyle = originalPointColor;\n    context.fillRect(x, y, pointWidth, pointHeight);\n\n    context.strokeStyle = STROKE_STYLE;\n    context.strokeRect(x, y, pointWidth, pointHeight);\n\n    highlightedBucket = null;\n  }\n\n  function getMousePos(event) {\n    const { left, top } = $canvas[0].getBoundingClientRect();\n    const { pageX, pageY } = event;\n    const pos = {\n      x: pageX - window.scrollX - left,\n      y: pageY - window.scrollY - top,\n      pageX,\n      pageY\n    };\n    return pos;\n  }\n\n  function drawCrosshair(pos) {\n    if (!carpet || !isInChart(pos)) {\n      clearCrosshair();\n      return;\n    }\n\n    carpet.selectAll('.heatmap-crosshair').remove();\n\n    const x = pos.x + yAxisWidth;\n    const y = pos.y + chartTop;\n\n    const crosshair = carpet.append('g')\n      .attr('class', 'heatmap-crosshair');\n\n    if (panel.xAxis.showCrosshair) {\n      crosshair.append('line')\n        .attr('x1', x)\n        .attr('y1', chartTop)\n        .attr('x2', x)\n        .attr('y2', chartBottom)\n        .attr('stroke-width', 1);\n    }\n\n    if (panel.yAxis.showCrosshair) {\n      crosshair.append('line')\n        .attr('x1', yAxisWidth)\n        .attr('y1', y)\n        .attr('x2', yAxisWidth + chartWidth)\n        .attr('y2', y)\n        .attr('stroke-width', 1);\n    }\n  }\n\n  function drawSharedCrosshair(pos) {\n    if (carpet) {\n      carpet.selectAll('.heatmap-crosshair').remove();\n\n      let posX = xScale(moment.utc(pos.x));\n\n      const crosshair = carpet.append('g')\n        .attr('class', 'heatmap-crosshair');\n\n      const x = posX + yAxisWidth;\n      crosshair.append('line')\n        .attr('x1', x)\n        .attr('y1', chartTop)\n        .attr('x2', x)\n        .attr('y2', chartBottom)\n        .attr('stroke-width', 1);\n    }\n  }\n\n  function clearCrosshair() {\n    if (!carpet) { return; }\n\n    carpet.selectAll('.heatmap-crosshair').remove();\n  }\n\n  function drawSelection(posX1, posX2) {\n    if (!carpet) { return; }\n\n    carpet.selectAll('.carpet-selection').remove();\n    const selectionX = Math.min(posX1, posX2) + yAxisWidth;\n    const selectionWidth = Math.abs(posX1 - posX2);\n\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\n      carpet.append('rect')\n        .attr('class', 'carpet-selection')\n        .attr('x', selectionX)\n        .attr('width', selectionWidth)\n        .attr('y', chartTop)\n        .attr('height', chartHeight);\n    }\n  }\n\n  function clearSelection() {\n    selection.x1 = -1;\n    selection.x2 = -1;\n\n    if (!carpet) { return; }\n\n    carpet.selectAll('.carpet-selection').remove();\n  }\n\n  function drawColorLegend() {\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\n\n    const legend = d3.select(\"#heatmap-color-legend\");\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\n\n    drawLegend(legend, legendWidth, legendHeight);\n  }\n\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\n    const legendColorScale = getColorScale(0, legendWidth);\n    const valuesRange = d3.range(0, legendWidth, rangeStep);\n\n    return legend.selectAll(\".heatmap-color-legend-rect\")\n      .data(valuesRange)\n      .enter()\n      .append(\"rect\")\n      .attr(\"x\", d => d)\n      .attr(\"y\", 0)\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\n      .attr(\"height\", legendHeight)\n      .attr(\"stroke-width\", 0)\n      .attr(\"fill\", d => legendColorScale(d));\n  }\n\n  // Helpers\n  function isInChart(pos) {\n    const { x, y } = pos;\n\n    return x > 0\n      && x < chartWidth\n      && y > 0\n      && y < chartHeight;\n  }\n\n  function getBucket(pos) {\n    const { x, y } = pos;\n\n    const bucketTimestamp = fragment.getBucketTimestamp(moment(xScale.invert(x)).valueOf());\n    const xTime = moment.utc(bucketTimestamp);\n    const index = fragment.getBucketIndex(xTime, xFrom);\n\n    const target = invertedYScale(y);\n    const bucketIndex = _.indexOf(targets, target);\n\n    const bucketX = xScale(xTime.toDate());\n    const bucketY = pointHeight * bucketIndex;\n\n    return _.has(data, `data[${index}].buckets[${target}]`)\n      ? {\n        x: bucketX,\n        y: bucketY,\n        target: target,\n        timestamp: data.data[index].timestamp,\n        value: data.data[index].buckets[target],\n        hasValue() {\n          return this.value !== null;\n        },\n        equals(bucket) {\n          return bucket && bucket.x === this.x && bucket.y === this.y;\n        }\n      }\n      : null;\n  }\n\n  function hasData() {\n    return data && data.data;\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function render() {\n    data = ctrl.data;\n    panel = ctrl.panel;\n    timeRange = ctrl.range;\n\n    targets = ctrl.data.targets;\n    fragment = getFragment(panel.fragment)\n\n    if (!d3.select('#heatmap-color-legend').empty()) {\n      drawColorLegend();\n    }\n\n    addCarpetplot();\n\n    scope.hasData = hasData;\n    scope.isInChart = isInChart;\n\n    ctrl.renderingCompleted();\n  }\n\n  $carpet.on('mousedown', onMouseDown);\n  $carpet.on('mousemove', onMouseMove);\n  $carpet.on('mouseleave', onMouseLeave);\n}"]}